apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-android-extensions'
apply plugin: 'jacoco-android'

jacoco {
    toolVersion = "0.8.3"
}

android {
    compileSdkVersion rootProject.ext.compileSdkVersion

    defaultConfig {
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode rootProject.ext.versionCode
        versionName rootProject.ext.versionName

        // Use the test runner with JUnit4 support
        testInstrumentationRunner 'androidx.test.runner.AndroidJUnitRunner'
    }

    buildTypes {
        debug {
            testCoverageEnabled = true
        }
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }

    // Fix for DuplicateFileException when using Espresso (https://code.google.com/p/android/issues/detail?id=195331)
    packagingOptions {
        exclude 'META-INF/maven/com.google.guava/guava/pom.properties'
        exclude 'META-INF/maven/com.google.guava/guava/pom.xml'
    }

    // Fix for androidTest builds due to Play Services Vision and Espresso creating their own protobuf.meta files
    packagingOptions {
        pickFirst 'protobuf.meta'
    }

    testOptions {
        execution 'ANDROIDX_TEST_ORCHESTRATOR'
        unitTests {
            includeAndroidResources = true
        }
    }

    sourceSets {
        debug {
            res.srcDirs += "$rootProject.projectDir/ginivision/src/test/res"
        }
    }
}

dependencies {
    api deps.slf4j
    api deps.androidxCore
    api deps.androidxAppCompat
    api deps.androidxFragment
    api deps.androidxViewPager
    api deps.androidxRecyclerView
    api deps.androidxLegacySupportV13
    api deps.materialDesign
    api deps.androidxCardView
    api deps.androidxAnnotations
    api deps.playServicesVision

    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlinVersion"
    implementation deps.commonsImaging
    implementation deps.completableFuture
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation fileTree(dir: '${project.rootDir}/tools/doccheck-doclet', include: ['*.jar'])
    implementation deps.androidxCardView

    testImplementation deps.junit
    testImplementation deps.truth
    testImplementation deps.mockito
    testImplementation deps.mockitoKotlin
    testImplementation deps.robolectric
    testImplementation deps.androidxTestCore
    testImplementation deps.androidxTestJUnit
    testImplementation deps.androidxTestRunner
    testImplementation deps.androidxTestEspressoCore
    testImplementation deps.androidxTestEspressoIntents

    androidTestImplementation deps.androidxTestCore
    androidTestImplementation deps.androidxTestJUnit
    androidTestImplementation deps.androidxTestRunner
    androidTestImplementation deps.truth
    androidTestImplementation deps.androidxTestRules
    androidTestImplementation deps.androidxTestEspressoCore
    androidTestImplementation deps.androidxTestEspressoIntents
    androidTestImplementation deps.androidxTestUiAutomator
    androidTestImplementation deps.mockito
    androidTestImplementation deps.mockitoAndroid
    androidTestImplementation deps.androidxMultidex

    androidTestUtil deps.androidxTestOrchestrator
}

apply from: rootProject.file('gradle/codequality.gradle')
apply from: rootProject.file('gradle/maven.gradle')
apply from: rootProject.file('gradle/javadoc_coverage.gradle')
apply from: rootProject.file('gradle/multidex_for_tests.gradle')

task generateJavadoc(type: GenerateJavadoc) {
    projectTitle = "Gini Vision Library for Android"
}

task sourcesJar(type: Jar, dependsOn: 'assembleRelease') {
    classifier = 'sources'
    from android.sourceSets.main.java.srcDirs
}

task javadocJar(type: Jar, dependsOn: generateJavadoc) {
    classifier = 'javadoc'
    from destinationDir
}

artifacts {
    archives sourcesJar
    archives javadocJar
}

task unifyConnectedTestCoverage {
    description = "Adds the connected tests' coverage to the JacocoReport tasks."
    doLast {
        unifyTestCoverage(firstSubfolderOf("${buildDir}/outputs/code_coverage/debugAndroidTest/connected"))
    }
}

static def firstSubfolderOf(dir) {
    File directory = new File(dir)
    if (directory.list().length == 0) {
        return
    }
    def subdir = directory.list()[0]
    return new File(directory, subdir)
}

def unifyTestCoverage(coverageFilesPath) {
    tasks.withType(JacocoReport) { task ->
        File execDataDir = file(coverageFilesPath)
        if (execDataDir.exists() && execDataDir.isDirectory() && execDataDir.listFiles().length > 0) {
            File[] execDataDirContents = execDataDir.listFiles()
            task.executionData.from(files { execDataDirContents })
        }
    }
}
